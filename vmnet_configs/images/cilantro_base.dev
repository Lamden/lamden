FROM ubuntu:18.04

MAINTAINER Falcon Wong version: 0.1

COPY . /app
WORKDIR /app

ENV MARIADB_MAJOR 10.0
ENV DOCKERIZE_VERSION v0.6.1

RUN apt-get update \
    && apt-get install -y software-properties-common wget \
    && apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8 \
    && add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mirrors.accretive-networks.net/mariadb/repo/10.3/ubuntu bionic main' \
    && apt-get remove -y software-properties-common \
    && apt autoremove -y \
    && apt-get update | \
    { \
        echo "mariadb-server-$MARIADB_MAJOR" mysql-server/root_password password 'unused'; \
        echo "mariadb-server-$MARIADB_MAJOR" mysql-server/root_password_again password 'unused'; \
    } | debconf-set-selections \
    && apt-get install -y libmysqlclient-dev mariadb-server mariadb-plugin-rocksdb \
    && rm -rf /var/lib/apt/lists/*

RUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz

# Install Python requirements
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        sudo ssh tar gzip ca-certificates curl \
        openssl python3.6 \
        python3-pip python3.6-dev build-essential \
        gcc g++ git autoconf automake \
        libffi-dev libtool dpkg \
        gsl-bin zlib1g-dev libboost-all-dev \
    && pip3 install --upgrade setuptools wheel \
    && pip3 install -r requirements.txt \
    && pip3 install -r dev-requirements.txt \
    && rm -rf pyzmq 2>/dev/null \
    && git clone https://github.com/zeromq/pyzmq.git \
        && apt install libzmq3-dev -y --no-install-recommends \
        && cd pyzmq \
        && cp zmq/utils/*.h zmq/backend/cython/ \
        && cp zmq/utils/*.h zmq/devices/ \
        && cythonize -ki zmq \
        && python3 setup.py install \
        && cd - \
    && rm -rf pynacl 2>/dev/null \
    && git clone https://github.com/pyca/pynacl.git \
        && cd pynacl \
        && cythonize -ki src/nacl \
        && python3 setup.py install \
        && cd - \
    && rm -rf pyzmq pynacl capnproto \
    && apt-get remove -y --allow-remove-essential \
        build-essential \
        gcc g++ \
        libffi-dev libtool \
        gsl-bin zlib1g-dev libboost-all-dev \
        autoconf automake \
    && apt autoremove -y \
    && rm -rf /var/lib/apt/lists/*

CMD sh /app/scripts/start_mysql.sh & mysqld \
        --skip-grant-tables \
        --skip-innodb \
        --collation-server latin1_bin \
        --default-storage-engine ROCKSDB \
        --default-tmp-storage-engine MyISAM \
        --binlog_format ROW \
        --user=root
